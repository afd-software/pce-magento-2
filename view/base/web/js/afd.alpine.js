var q=Object.defineProperty,K=Object.defineProperties;var W=Object.getOwnPropertyDescriptors;var R=Object.getOwnPropertySymbols;var $=Object.prototype.hasOwnProperty,j=Object.prototype.propertyIsEnumerable;var x=(a,e,t)=>e in a?q(a,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):a[e]=t,c=(a,e)=>{for(var t in e||(e={}))$.call(e,t)&&x(a,t,e[t]);if(R)for(var t of R(e))j.call(e,t)&&x(a,t,e[t]);return a},v=(a,e)=>K(a,W(e));var m=a=>class extends a{constructor(...e){super(...e),this.connected=new Promise(t=>{this.resolver=t})}connectedCallback(){this.resolver()}whenConnected(){return this.connected}set visible(e){this.style.display=e?"block":"none"}debug(e,t={}){}};var w=a=>{let{serial:e,password:t,id:s,token:i}=a;if(e&&t&&s&&i)throw new Error("Both serial/password and id/token pairs should not be used together.");if(!e&&!t&&!s&&!i)throw new Error("Either a combination of serial and password or id and token must be used.");if(e&&!t||!e&&t)throw new Error("Both serial and password must be supplied together.");if(s&&!i||!s&&i)throw new Error("Both id and token must be supplied together.");e&&t&&console.warn("Warning: Serial and password are for development purposes only.");let n=new URLSearchParams;return s&&i?(n.append("id",s),n.append("token",i)):e&&t&&(n.append("serial",e),n.append("password",t)),n.append("intf","alp010000"),n.append("format","json"),n},L=async a=>{let{pceURL:e,uniqueID:t,signal:s,lookup:i,maxItems:n,matchPositions:o,country:r,postcodeFirst:p}=a,l=w(a);l.append("lookup",i),l.append("data","address"),l.append("task","fastfindv4");let h=["USA","US"].indexOf(r.toUpperCase())>-1;l.append("fields",h||p?"list":"fflist"),h&&!p&&l.append("listenv","1"),l.append("maxQuantity",n.toString()),o&&l.append("matchPositions","1"),l.append("uniqueID",t),l.append("countryISO",r);let y=`${e}?${l.toString()}`;return fetch(y,{signal:s})},T=async a=>{let{pceURL:e,key:t,country:s,crownCountry:i}=a,n=w(a);n.append("key",t),n.append("data","address"),n.append("task","retrieve"),n.append("fields",a.retrieveFields),n.append("countryISO",s),i&&n.append("crownCountry","1");let o=`${e}?${n.toString()}`;return fetch(o)};var E=class extends m(HTMLInputElement){constructor(){super(...arguments);this._maxItems=5;this._matchPositions=!0}connectedCallback(){this.resolver(),this.controller=null,this.addEventListener("input",this.onInput),this.addEventListener("keydown",this._onKeyDown)}set onKeyDown(t){this._onKeyDown=t}set country(t){this._country=t}set credentials(t){this._credentials=t}set maxItems(t){this._maxItems=t}set matchPositions(t){this._matchPositions=t}set placeholder(t){this.setAttribute("placeholder",t)}set lookupResponseHandler(t){this._lookupResponseHandler=t}set postcodeFirst(t){this._postcodeFirst=t}setUniqueID(){this._uniqueID=Math.random().toString(36).substring(7)}async onInput(t){try{if(this.controller&&this.controller.abort(),this.controller=new AbortController,!t.target)return;let i=await(await L(v(c({},this._credentials),{lookup:t.target.value,uniqueID:this._uniqueID,signal:this.controller.signal,maxItems:this._maxItems,matchPositions:this._matchPositions,postcodeFirst:this._postcodeFirst,country:this._country}))).json();this._lookupResponseHandler(i.Item)}catch(s){if(s.name==="AbortError")return;console.error(s)}}};customElements.define("afd-typeahead-input",E,{extends:"input"});var C=class extends m(HTMLElement){static get observedAttributes(){return["active","key"]}constructor(){super(),this.attachShadow({mode:"open"})}connectedCallback(){this.resolver(),this.render(),this.addEventListener("click",this.onClick.bind(this)),this.addEventListener("mouseover",this._onMouseOver),this.addEventListener("mouseout",this._onMouseOut)}render(){this.isConnected&&this.shadowRoot&&(this.shadowRoot.innerHTML=`
      <style>
        :host {
          --afd-result-background-color-active: #2272B9;
          --afd-result-color-active: #fff;
          --afd-result-background-color: #fff;
          --afd-result-color: #2c3c5;
          color: var(--afd-result-color);
          background-color: var(--afd-result-background-color);
          display: block;
          padding: 0.5rem;
          cursor: pointer;
          font-family: sans-serif;
          transition: background-color 0.3s ease, color 0.3s ease;
        }
        :host([active]) {
          background-color: var(--afd-result-background-color-active);
          color: var(--afd-result-color-active);
          transition: background-color 0.3s ease, color 0.3s ease;
          }
          .afd-matched-position {
            font-weight: bold;
          }
      </style>
      <div  part="content">${this._list}</div>
  `)}get key(){return this._key}set item(e){this._list=e.List,this._key=e.Key,this.render()}set active(e){e?this.setAttribute("active",""):this.removeAttribute("active")}onClick(){this.dispatchEvent(new CustomEvent("selectPCEResult",{detail:{key:this._key},bubbles:!0,composed:!0}))}set onMouseOver(e){this._onMouseOver=e}set onMouseOut(e){this._onMouseOut=e}};customElements.define("afd-typeahead-results-item",C);var g=class extends m(HTMLElement){constructor(){super(...arguments);this._activeIndex=-1;this._listItems=[]}connectedCallback(){this.style.display="none",this.resolver(),this.addEventListener("selectPCEResult",this.onSelectPCEResult),this.tabIndex=0,this.focus()}set items(t){this.reset(),t.forEach(s=>{let i=document.createElement("afd-typeahead-results-item");i.item=s,i.onMouseOver=this.onListItemMouseOver.bind(this),i.onMouseOut=this.onListItemMouseOut.bind(this),this.appendChild(i)}),this._listItems=Array.from(this.children),this.style.display="block"}get activeIndex(){return this._activeIndex}set activeIndex(t){this._activeIndex=t,this._listItems.forEach(s=>{s.active=!1}),this._activeIndex!==-1&&(this._listItems[this._activeIndex].active=!0)}reset(){this.innerHTML="",this.style.display="none",this._activeIndex=-1}onSelectPCEResult(){this.reset()}onListItemMouseOver(t){let s=t.target;this.activeIndex=this._listItems.indexOf(s)}onListItemMouseOut(){this.activeIndex=-1}};customElements.define("afd-typeahead-results",g);var k=class extends m(HTMLElement){connectedCallback(){this.resolver(),this.addEventListener("click",this._onClick),Object.assign(this.style,{cursor:"pointer",fontFamily:"Arial, sans-serif"})}set text(e){this.innerText=e}set onClick(e){this._onClick=e}set visible(e){this.style.display=e?"inline-block":"none"}};customElements.define("afd-typeahead-utility",k);var P={pceURL:"https://apps.afd.co.uk/json",beforeHideResults:!0,manualInput:!0,manualInputText:"Enter address manually",manualInputAddressSearchText:"Search for address",afterHideTypeahead:!0,searchAgain:!0,searchAgainText:"Search again",fewResultsManualInput:!0,fewResultsManualInputText:"Can't find you address? Enter it manually",afterClearTypeahead:!0,hideEmpties:!1,maxItems:5,matchPositions:!0,defaultCountry:"GB",retrieveFields:"standard",postcodeFirst:!0,placeholder:"Start typing your address",showForCountries:[],hideForCountries:[]};var D=class extends m(HTMLElement){constructor(){super(...arguments);this.initialised=!1;this._state={id:"",isTypeaheadActive:!1,addressStoreEmpty:!0,isManualInput:!1,selectedItem:{"@value":""},country:""};this.countrySetCount=0;this._typeaheadOptions=P}connectedCallback(){this.debug("connectedCallback",this._typeaheadOptions),this.resolver(),this.addEventListener("selectPCEResult",this.onSelectPCEResult),this.addEventListener("pceLookupResultReceived",this.onPCELookupResultReceived),!this.initialised&&this.init()}initInput(){let t=!this._input;t&&(this._input=document.createElement("input",{is:"afd-typeahead-input"})),this._input.onKeyDown=this.onInputKeyDown.bind(this),this._input.maxItems=this._typeaheadOptions.maxItems,this._input.matchPositions=this._typeaheadOptions.matchPositions,this._input.setUniqueID(),this._input.lookupResponseHandler=this.handlePCELookupResponse.bind(this),this._input.placeholder=this._typeaheadOptions.placeholder,this._input.postcodeFirst=this._typeaheadOptions.postcodeFirst,this._input.visible=this._state.isTypeaheadActive,this._typeaheadOptions.inputClass&&this._input.classList.add(this._typeaheadOptions.inputClass);let{pceURL:s,serial:i,password:n,id:o,token:r}=this._typeaheadOptions;this._input.credentials={pceURL:s,serial:i,password:n,id:o,token:r},t&&this.appendChild(this._input)}initResults(){!this._results&&(this._results=document.createElement("afd-typeahead-results"),this.appendChild(this._results))}initManualInput(){let{beforeHideResults:t,manualInput:s,manualInputText:i}=this._typeaheadOptions,n=!this._manualInput;n&&(this._manualInput=document.createElement("afd-typeahead-utility")),this._manualInput.text=i,this._manualInput.visible=t&&s&&this._state.isTypeaheadActive,this._manualInput.onClick=this.onManualInputClick.bind(this),n&&this.appendChild(this._manualInput)}initManualInputAddressSearch(){let t=!this._manualInputAddressSearch;t&&(this._manualInputAddressSearch=document.createElement("afd-typeahead-utility")),this._manualInputAddressSearch.text=this._typeaheadOptions.manualInputAddressSearchText,this._manualInputAddressSearch.visible=!1,this._manualInputAddressSearch.onClick=this.onManualInputAddressSearchClick.bind(this),t&&this.appendChild(this._manualInputAddressSearch)}initSearchAgain(){if(!this._typeaheadOptions.searchAgain)return;let t=!this._searchAgain;t&&(this._searchAgain=document.createElement("afd-typeahead-utility")),this._searchAgain.text=this._typeaheadOptions.searchAgainText,this._searchAgain.visible=!1,this._searchAgain.onClick=this.onSearchAgainClick.bind(this),t&&this.appendChild(this._searchAgain)}init(){if(this.debug("init",this._typeaheadOptions),this.initialised){this.debug("already initialised");return}this.initInput(),this.initResults(),this.initManualInput(),this.initManualInputAddressSearch(),this.initSearchAgain(),this.initialised=!0}set typeaheadOptions(t){this.debug("set typeaheadOptions",t),this._typeaheadOptions=c(c({},this._typeaheadOptions),t),this.init()}set items(t){let s=this.querySelector("afd-typeahead-results");s.items=t}set store(t){this._store=t}set country(t){if(this.debug("set country",this._typeaheadOptions),!t){this.debug("no country");return}this._country=t.toUpperCase(),this._input&&(this._input.country=t.toUpperCase()),this.countrySetCount++,this.resetState()}updateState(t){this.debug("updateState",t),this._state=c(c({},this._state),t),this._store(this._state)}onSelectPCEResult(t){if(this.debug("onSelectPCEResult",t.detail),t.detail.key==="manual"){this.onManualInputClick();return}this.pceRetrieve(t.detail.key)}onInputKeyDown(t){let s=Array.from(this._results.children);if(t.key==="ArrowDown")this._results.activeIndex=(this._results.activeIndex+1)%s.length;else if(t.key==="ArrowUp")this._results.activeIndex=(this._results.activeIndex-1+s.length)%s.length;else if(t.key==="Enter"){this.pceRetrieve(s[this._results.activeIndex].key),this._results.reset(),t.preventDefault();return}else return}onPCELookupResultReceived(t){this._results.items=t.detail}onManualInputClick(){this._results.reset(),this._input.visible=!1,this._manualInput.visible=!1,this._manualInputAddressSearch.visible=!0,this.updateState({isManualInput:!0})}onManualInputAddressSearchClick(){this._results.reset(),this._input.visible=!0,this._manualInput.visible=!0,this._manualInputAddressSearch.visible=!1,this.updateState({isManualInput:!1})}onSearchAgainClick(){this.resetState()}resetState(){this.debug("resetState",this._typeaheadOptions),this._results.reset();let t={addressStoreEmpty:!0,isManualInput:!1,country:this._country};if(this.countrySetCount>1&&(t.selectedItem={"@value":""}),this._typeaheadOptions.hideForCountries.length>0&&this._typeaheadOptions.hideForCountries.indexOf(this._country)>-1||this._typeaheadOptions.showForCountries.length>0&&this._typeaheadOptions.showForCountries.indexOf(this._country)===-1){this.updateState(v(c({},t),{isTypeaheadActive:!1})),this._input.visible=!1,this._manualInput!==void 0&&(this._manualInput.visible=!1),this._manualInputAddressSearch&&(this._manualInputAddressSearch.visible=!1),this._searchAgain&&(this._searchAgain.visible=!1);return}this.updateState(v(c({},t),{isTypeaheadActive:!0})),this._input.visible=!0,this._typeaheadOptions.beforeHideResults&&this._typeaheadOptions.manualInput&&(this._manualInput.visible=!0),this._searchAgain.visible=!1,this._input.focus(),this._input.value=""}async pceRetrieve(t){let s=await T(v(c({},this._typeaheadOptions),{key:t,country:this._country,crownCountry:this._typeaheadOptions.setCrownDependencyCountry}));this._manualInput&&(this._manualInput.visible=!1),this._manualInputAddressSearch.visible=!1,this._searchAgain&&(this._searchAgain.visible=this._typeaheadOptions.afterHideTypeahead&&this._typeaheadOptions.searchAgain),this._input.visible=!this._typeaheadOptions.afterHideTypeahead,this._input.value=this._typeaheadOptions.afterClearTypeahead?"":this._input.value;let i=await s.json();this.dispatchEvent(new CustomEvent("afd::addressRetrieveComplete",{detail:i})),this._input.setUniqueID(),this.updateState({addressStoreEmpty:!1,selectedItem:i.Item[0]})}handlePCELookupResponse(t){let{maxItems:s,fewResultsManualInput:i,fewResultsManualInputText:n,matchPositions:o}=this._typeaheadOptions;t.length<s&&i&&t.push({"@value":"",List:n,Key:"manual"}),t=o?this.handleMatchPositions(t):t,this._results.items=t}handleMatchPositions(t){return t.map(s=>{if(!s.matchPositions)return s;let i=[],n=0;return s.matchPositions.forEach(o=>{let[r,p]=o;i.push(s.List.substring(n,r));let l=s.List.substring(r,p);i.push(`<span class="afd-matched-position">${l}</span>`),n=p}),i.push(s.List.substring(n)),v(c({},s),{List:i.join("")})})}};customElements.define("afd-typeahead",D);var M=a=>{a.directive("afd-typeahead",(e,{expression:t},{evaluate:s,effect:i})=>{try{let n=e,o=s(t),r=s('typeof afdFormID !== "undefined" ? afdFormID : ""  '),p="AFDState"+(r||""),l="AFDCountry"+(r||""),h=document.createElement("afd-typeahead");a.store(p,{addressStoreEmpty:!0,isManualInput:!1,hasRetrieved:!1,selectedItem:{"@value":""}}),h.store=u=>{a.store(p,u)},h.typeaheadOptions=o,a.store("AFDOptions",o);let y="";n.appendChild(h),i(()=>{let u=a.store(l);u!==void 0&&y!==u&&(h.country=u,y=u)})}catch(n){console.error(n)}}),a.directive("afd-address-field",(e,{expression:t},{evaluateLater:s,effect:i,evaluate:n})=>{try{let o=e,r=n('typeof afdFormID !== "undefined" ? "afdFormID" : ""'),p="AFDState"+(r||""),l=s("$store.AFDOptions"),h=s("$store."+p),y="afd"+t+r;o.setAttribute("x-data",y),o.setAttribute("x-show","visible"),o.setAttribute("x-transition",""),a.data(y,()=>({init:function(){let u=o.querySelector("input"),d=o.querySelector("select");this.initialValue=d?d.value:u?u.value:"";let _=!1;i(()=>{h(I=>{u=o.querySelector("input"),d=o.querySelector("select"),this.initialValue=d?d.value:u?u.value:"";let{selectedItem:A,addressStoreEmpty:b,isManualInput:H,isTypeaheadActive:U,country:F}=I,B=t.split("_"),f="";if(B.forEach(O=>{f.length>0&&(f+=", "),f+=A[O]?A[O]:""}),f===void 0)return;this.value=f,u&&(u.value=f,f&&u.blur()),d&&(d.value=this.options.regionMap(A),f&&d.blur());let S=F&&this.country===void 0;S&&this.initialValue&&(this.value=this.initialValue,u&&(u.value=this.initialValue)),this.country=F,this.visible=!_&&!!this.value||!!this.value&&S||!U||H||b&&!this.options.beforeHideResults||!b&&this.options.hideEmpties&&this.value.length>0||!b&&!this.options.hideEmpties}),_=!0}),i(()=>{l(I=>{this.options!==void 0&&(this.options=I)})})},options:{},value:"",initialValue:"",visible:!1,country:""}))}catch(o){console.error(o)}}),a.directive("afd-country",(e,{expression:t},{evaluate:s,evaluateLater:i,effect:n})=>{let o=e,r=s('typeof afdFormID !== "undefined" ? afdFormID : ""  '),p="AFDCountry"+(r||""),l="AFDState"+(r||""),h=i("$store.AFDOptions"),y=i("$store."+l),u="afd"+t+r;o.setAttribute("x-data",u),a.data(u,()=>({init:function(){let d=!1;n(()=>{h(_=>{this.options=_})}),n(()=>{y(_=>{let I=_.selectedItem;if(this.options.setCrownDependencyCountry&&I.CountryISO==="GBR"){switch(d=!0,I.Country){case"Isle of Man":o.value="IM";break;case"Jersey":o.value="JE";break;case"Guernsey":o.value="GG";break}d=!1}})}),a.store(p,o.value),o.addEventListener("change",()=>{d||a.store(p,o.value)})},options:{}}))})};window&&window.addEventListener("alpine:init",()=>{M(window.Alpine)});
