(()=>{"use strict";const t=t=>class extends t{resolver;connected;constructor(...t){super(...t),this.connected=new Promise((t=>{this.resolver=t}))}connectedCallback(){this.resolver()}whenConnected(){return this.connected}set visible(t){this.style.display=t?"block":"none"}},e=t=>{const{serial:e,password:s,id:i,token:n}=t;if(e&&s&&i&&n)throw new Error("Both serial/password and id/token pairs should not be used together.");if(!(e||s||i||n))throw new Error("Either a combination of serial and password or id and token must be used.");if(e&&!s||!e&&s)throw new Error("Both serial and password must be supplied together.");if(i&&!n||!i&&n)throw new Error("Both id and token must be supplied together.");e&&s&&console.warn("Warning: Serial and password are for development purposes only.");const a=new URLSearchParams;return i&&n?(a.append("id",i),a.append("token",n)):e&&s&&(a.append("serial",e),a.append("password",s)),a.append("intf","alp010000"),a.append("format","json"),a};class s extends(t(HTMLInputElement)){_uniqueID;_onKeyDown;_credentials;_maxItems=5;_matchPositions=!0;_lookupResponseHandler;_country;_postcodeFirst;controller;connectedCallback(){this.resolver(),this.controller=null,this.addEventListener("input",this.onInput),this.addEventListener("keydown",this._onKeyDown)}set onKeyDown(t){this._onKeyDown=t}set country(t){this._country=t}set credentials(t){this._credentials=t}set maxItems(t){this._maxItems=t}set matchPositions(t){this._matchPositions=t}set placeholder(t){this.setAttribute("placeholder",t)}set lookupResponseHandler(t){this._lookupResponseHandler=t}set postcodeFirst(t){this._postcodeFirst=t}setUniqueID(){this._uniqueID=Math.random().toString(36).substring(7)}async onInput(t){try{if(this.controller&&this.controller.abort(),this.controller=new AbortController,!t.target)return;const s=t.target.value;if(!s||""===s.trim())return void this._lookupResponseHandler([]);const i=await(async t=>{const{pceURL:s,uniqueID:i,signal:n,lookup:a,maxItems:o,matchPositions:r,country:h,postcodeFirst:d}=t,l=e(t);l.append("lookup",a),l.append("data","address"),l.append("task","fastfindv4"),"US"!==h&&"USA"!==h||d?l.append("fields",d?"list":"fflist"):l.append("listenv","1"),l.append("maxQuantity",o.toString()),l.append("uniqueID",i),l.append("countryISO",h),r&&l.append("matchPositions","1");const u=`${s}?${l.toString()}`;return fetch(u,{signal:n})})({...this._credentials,lookup:s,uniqueID:this._uniqueID,signal:this.controller.signal,maxItems:this._maxItems,matchPositions:this._matchPositions,postcodeFirst:this._postcodeFirst,country:this._country}),n=await i.json();this._lookupResponseHandler(n.Item)}catch(t){if("AbortError"===t.name)return;console.error(t)}}}customElements.define("afd-typeahead-input",s,{extends:"input"});class i extends(t(HTMLElement)){static get observedAttributes(){return["active","key"]}_list;_key;_onMouseOver;_onMouseOut;constructor(){super(),this.attachShadow({mode:"open"})}connectedCallback(){this.resolver(),this.render(),this.addEventListener("click",this.onClick.bind(this)),this.addEventListener("mouseover",this._onMouseOver),this.addEventListener("mouseout",this._onMouseOut)}render(){this.isConnected&&this.shadowRoot&&(this.shadowRoot.innerHTML=`\n      <style>\n        :host {\n          --afd-result-background-color-active: #2272B9;\n          --afd-result-color-active: #fff;\n          --afd-result-background-color: #fff;\n          --afd-result-color: #2c3c5;\n          color: var(--afd-result-color);\n          background-color: var(--afd-result-background-color);\n          display: block;\n          padding: 0.5rem;\n          cursor: pointer;\n          font-family: sans-serif;\n          transition: background-color 0.3s ease, color 0.3s ease;\n        }\n        :host([active]) {\n          background-color: var(--afd-result-background-color-active);\n          color: var(--afd-result-color-active);\n          transition: background-color 0.3s ease, color 0.3s ease;\n          }\n          .afd-matched-position {\n            font-weight: bold;\n          }\n      </style>\n      <div  part="content">${this._list}</div>`)}get key(){return this._key}set item(t){this._list=t.List,this._key=t.Key,this.render()}set active(t){t?this.setAttribute("active",""):this.removeAttribute("active")}onClick(){this.dispatchEvent(new CustomEvent("selectPCEResult",{detail:{key:this._key},bubbles:!0,composed:!0}))}set onMouseOver(t){this._onMouseOver=t}set onMouseOut(t){this._onMouseOut=t}}customElements.define("afd-typeahead-results-item",i);class n extends(t(HTMLElement)){_activeIndex=-1;_listItems=[];connectedCallback(){this.style.display="none",this.resolver(),this.addEventListener("selectPCEResult",this.onSelectPCEResult),this.tabIndex=0,this.focus()}set items(t){this.reset(),t&&0!==t.length&&(t.forEach((t=>{const e=document.createElement("afd-typeahead-results-item");e.item=t,e.onMouseOver=this.onListItemMouseOver.bind(this),e.onMouseOut=this.onListItemMouseOut.bind(this),this.appendChild(e)})),this._listItems=Array.from(this.children),this.style.display="block")}get activeIndex(){return this._activeIndex}set activeIndex(t){this._activeIndex=t,this._listItems.forEach((t=>{t.active=!1})),-1!==this._activeIndex&&(this._listItems[this._activeIndex].active=!0)}reset(){this.innerHTML="",this.style.display="none",this._activeIndex=-1}onSelectPCEResult(){this.reset()}onListItemMouseOver(t){const e=t.target;this.activeIndex=this._listItems.indexOf(e)}onListItemMouseOut(){this.activeIndex=-1}}customElements.define("afd-typeahead-results",n);class a extends(t(HTMLElement)){_onClick;connectedCallback(){this.resolver(),this.addEventListener("click",this._onClick),Object.assign(this.style,{cursor:"pointer",fontFamily:"Arial, sans-serif"})}set text(t){this.innerText=t}set onClick(t){this._onClick=t}}customElements.define("afd-typeahead-utility",a);const o={pceURL:"https://apps.afd.co.uk/json",beforeHideResults:!0,manualInput:!0,manualInputText:"Enter address manually",manualInputAddressSearchText:"Search for address",afterHideTypeahead:!0,searchAgain:!0,searchAgainText:"Search again",fewResultsManualInput:!0,fewResultsManualInputText:"Can't find you address? Enter it manually",afterClearTypeahead:!0,hideEmpties:!1,maxItems:5,matchPositions:!0,defaultCountry:"GB",retrieveFields:"standard",postcodeFirst:!0,placeholder:"Start typing your address"};class r extends(t(HTMLElement)){_input;_results;_manualInput;_manualInputAddressSearch;_searchAgain;_store;_country;_state={id:"",addressStoreEmpty:!0,isManualInput:!1,selectedItem:{"@value":""}};_typeaheadOptions=o;connectedCallback(){this.resolver(),this.init(),this.addEventListener("selectPCEResult",this.onSelectPCEResult),this.addEventListener("pceLookupResultReceived",this.onPCELookupResultReceived)}initInput(){this._input||(this._input=document.createElement("input",{is:"afd-typeahead-input"}),this._input.onKeyDown=this.onInputKeyDown.bind(this),this._input.maxItems=this._typeaheadOptions.maxItems,this._input.matchPositions=this._typeaheadOptions.matchPositions,this._input.setUniqueID(),this._input.lookupResponseHandler=this.handlePCELookupResponse.bind(this),this._input.placeholder=this._typeaheadOptions.placeholder,this._input.postcodeFirst=this._typeaheadOptions.postcodeFirst,this.appendChild(this._input));const{pceURL:t,serial:e,password:s,id:i,token:n}=this._typeaheadOptions;this._input.credentials={pceURL:t,serial:e,password:s,id:i,token:n}}initResults(){this._results||(this._results=document.createElement("afd-typeahead-results"),this.appendChild(this._results))}initManualInput(){this._typeaheadOptions.manualInput&&!this._manualInput&&(this._manualInput=document.createElement("afd-typeahead-utility"),this._manualInput.text=this._typeaheadOptions.manualInputText,this._manualInput.visible=this._typeaheadOptions.beforeHideResults,this._manualInput.onClick=this.onManualInputClick.bind(this),this.appendChild(this._manualInput))}initManualInputAddressSearch(){this._typeaheadOptions.manualInput&&!this._manualInputAddressSearch&&(this._manualInputAddressSearch=document.createElement("afd-typeahead-utility"),this._manualInputAddressSearch.text=this._typeaheadOptions.manualInputAddressSearchText,this._manualInputAddressSearch.visible=!1,this._manualInputAddressSearch.onClick=this.onManualInputAddressSearchClick.bind(this),this.appendChild(this._manualInputAddressSearch))}initSearchAgain(){this._typeaheadOptions.searchAgain&&!this._searchAgain&&(this._searchAgain=document.createElement("afd-typeahead-utility"),this._searchAgain.text=this._typeaheadOptions.searchAgainText,this._searchAgain.visible=!1,this._searchAgain.onClick=this.onSearchAgainClick.bind(this),this.appendChild(this._searchAgain))}init(){this.initInput(),this.initResults(),this.initManualInput(),this.initManualInputAddressSearch(),this.initSearchAgain()}set typeaheadOptions(t){this._typeaheadOptions={...this._typeaheadOptions,...t},this.init(),this.country=this._typeaheadOptions.defaultCountry}set items(t){this.querySelector("afd-typeahead-results").items=t}set store(t){this._store=t}set country(t){this._country=t,this._input.country=t,this.resetState()}updateState(t){this._state={...this._state,...t},this._store(this._state)}onSelectPCEResult(t){t.stopPropagation(),"manual"!==t.detail.key?this.pceRetrieve(t.detail.key):this.onManualInputClick()}onInputKeyDown(t){const e=Array.from(this._results.children);if("ArrowDown"===t.key)this._results.activeIndex=(this._results.activeIndex+1)%e.length;else{if("ArrowUp"!==t.key)return"Enter"===t.key?(this.pceRetrieve(e[this._results.activeIndex].key),void this._results.reset()):void 0;this._results.activeIndex=(this._results.activeIndex-1+e.length)%e.length}}onPCELookupResultReceived(t){this._results.items=t.detail}onManualInputClick(){this._results.reset(),this._input.visible=!1,this._manualInput.visible=!1,this._manualInputAddressSearch.visible=!0,this.updateState({isManualInput:!0})}onManualInputAddressSearchClick(){this._results.reset(),this._input.visible=!0,this._manualInput.visible=this._typeaheadOptions.beforeHideResults,this._manualInputAddressSearch.visible=!1,this.updateState({isManualInput:!1})}onSearchAgainClick(){this.resetState()}resetState(){this.updateState({addressStoreEmpty:!0,isManualInput:!1,selectedItem:{"@value":""}}),this._results.reset(),this._input.visible=!0,this._manualInput.visible=this._typeaheadOptions.beforeHideResults&&this._typeaheadOptions.manualInput,this._searchAgain.visible=!1,this._input.focus(),this._input.value=""}async pceRetrieve(t){const s=await(async t=>{const{pceURL:s,key:i,country:n}=t,a=e(t);a.append("key",i),a.append("data","address"),a.append("task","retrieve"),a.append("fields",t.retrieveFields),a.append("countryISO",n);const o=`${s}?${a.toString()}`;return fetch(o)})({...this._typeaheadOptions,key:t,country:this._country});this._manualInput&&(this._manualInput.visible=!1),this._manualInputAddressSearch.visible=!1,this._searchAgain&&(this._searchAgain.visible=this._typeaheadOptions.afterHideTypeahead&&this._typeaheadOptions.searchAgain),this._input.visible=!this._typeaheadOptions.afterHideTypeahead,this._input.value=this._typeaheadOptions.afterClearTypeahead?"":this._input.value;const i=await s.json();this._input.setUniqueID(),this.updateState({addressStoreEmpty:!1,selectedItem:i.Item[0]})}handlePCELookupResponse(t){const{maxItems:e,fewResultsManualInput:s,fewResultsManualInputText:i,matchPositions:n}=this._typeaheadOptions;t.length<e&&s&&t.push({"@value":"",List:i,Key:"manual"}),t=n?this.handleMatchPositions(t):t,this._results.items=t}handleMatchPositions(t){return t.map((t=>{if(!t.matchPositions)return t;const e=[];let s=0;return t.matchPositions.forEach((i=>{const[n,a]=i;e.push(t.List.substring(s,n));const o=t.List.substring(n,a);e.push(`<span class="afd-matched-position">${o}</span>`),s=a})),e.push(t.List.substring(s)),{...t,List:e.join("")}}))}}customElements.define("afd-typeahead",r);const h=t=>{t.directive("afd-typeahead",((e,{expression:s},{evaluate:i,effect:n})=>{try{const a=e,o=i(s),r=i('typeof afdFormID !== "undefined" && afdFormID'),h="AFDState"+(r||""),d="AFDCountry"+(r||""),l=document.createElement("afd-typeahead");t.store(h,{addressStoreEmpty:!0,isManualInput:!1,selectedItem:{"@value":""}}),l.store=e=>{t.store(h,e)},l.typeaheadOptions=o,t.store("AFDOptions",o),a.appendChild(l);let u=t.store(d);n((()=>{const e=t.store(d);u!==e&&(l.country=t.store(d),u=e)}))}catch(t){console.error(t)}})),t.directive("afd-address-field",((e,{expression:s},{evaluateLater:i,effect:n,evaluate:a})=>{try{const o=e,r=a('typeof afdFormID !== "undefined" && afdFormID'),h="AFDState"+(r||""),d=i("$store.AFDOptions"),l=i("$store."+h),u=s.split("_"),p=u.length>1,c="afd"+s+r;o.setAttribute("x-data",c),o.setAttribute("x-show","visible"),o.setAttribute("x-transition","");const m=t=>u.map((e=>t[e])).filter((t=>t&&t.trim().length>0)).join(", ");t.data(c,(()=>({init:function(){n((()=>{l((t=>{const{selectedItem:e,addressStoreEmpty:i,isManualInput:n}=t,a=p?m(e):e[s];a&&(this.value=a),this.visible=!this.options.beforeHideResults||n||!i&&this.options.hideEmpties&&this.value.length>0||!i&&!this.options.hideEmpties}))})),n((()=>{d((t=>{this.options=t,this.visible=!this.options.beforeHideResults}))})),n((()=>{}))},options:{},value:"",visible:!1})));const _=o.querySelector("input");_&&(p?_.setAttribute("x-model","value"):_.setAttribute("x-model","$store."+h+".selectedItem."+s))}catch(t){console.error(t)}})),t.directive("afd-country",((e,s,{evaluate:i})=>{const n=e,a="AFDCountry"+(i('typeof afdFormID !== "undefined" && afdFormID')||"");e.addEventListener("change",(()=>{t.store(a,n.value)}))}))};window&&window.addEventListener("alpine:init",(()=>{console.log("alpine:init"),h(window.Alpine)}))})();